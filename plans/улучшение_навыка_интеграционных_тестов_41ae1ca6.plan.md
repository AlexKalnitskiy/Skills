---
name: Улучшение навыка интеграционных тестов
overview: "Анализ и улучшение навыка написания интеграционных тестов: исправление неточностей, добавление недостающей информации о паттернах проекта и уточнение правил использования IServiceProvider"
todos:
  - id: todo-1769715610186-9k2f1zf3e
    content: "Проверить, что все примеры инфраструктурного тестового кода используют папку Infrastructure для создания файлов (Пример: src/Tests/Infrastructure/RedisContainerExtensions.cs)"
    status: completed
  - id: add-roles
    content: Добавить раздел о ролях приложения (AsWorkControlRole, AsMailingsPipelineRole и т.д.)
    status: pending
  - id: add-assembly-init
    content: Добавить информацию о двух уровнях инициализации контейнеров (Assembly и Class)
    status: pending
  - id: add-testapp-pattern
    content: Добавить информацию о паттерне TestApp с общими контейнерами
    status: pending
  - id: add-kafka-methods
    content: Добавить информацию о всех методах KafkaContainerExtensions (GetBootstrapAddress, DeleteTopicsByPatternAsync)
    status: pending
  - id: add-wait-while-consumed
    content: Добавить пример использования WaitWhileTopicConsumedAsync
    status: pending
  - id: add-extension-pattern
    content: Добавить информацию о паттерне extension methods в C# 13
    status: pending
  - id: fix-examples-references
    content: Удалить или создать файлы EXAMPLES_*.md, на которые есть ссылки
    status: pending
isProject: false
---

# План улучшения навыка интеграционных тестов

## Выявленные проблемы

### 1. Отсутствующие файлы примеров
- В навыке упоминаются файлы `EXAMPLES_*.md` (CONTAINERS, WIREMOCK, WEBAPPLICATION, ASSERTIONS, TEST_DATA, CONFIG), но они отсутствуют в проекте
- **Решение**: Удалить ссылки на несуществующие файлы или создать их

### 2. Неточности в путях и названиях
- Указан неправильный путь: `src/Infrastructure/ConfigBuilderExtensions.cs` вместо `src/Infra/ConfigBuilderExtensions.cs`
- **Решение**: Исправить путь

### 3. Недостающая информация о паттернах проекта

#### 3.1. Extension methods pattern
- В проекте используется паттерн `extension(Action<IWebHostBuilder> apply)` из C# 13
- Не описано в навыке
- **Решение**: Добавить раздел о паттерне extension methods

#### 3.2. Роли приложения
- Существуют методы `AsWorkControlRole()`, `AsMailingsPipelineRole()`, `AsManualMailingsRole()`, `AsFrequencyPolicyRole()`
- Определены в `src/Worker.Tests/WebApplication/WebApplicationBuilderExtensions.cs`
- Используются для настройки роли приложения через `HOST_CONFIGURATION:ROLE`
- **Решение**: Добавить раздел о ролях приложения

#### 3.3. Assembly-level контейнеры
- Контейнеры могут быть на уровне Assembly через `[AssemblyInitialize]` и `[AssemblyCleanup]`
- Пример: `TestApp` класс в `src/Services.Tests/TestApp.cs` и `src/Worker.Tests/WebApplication/TestApp.cs`
- **Решение**: Добавить информацию о двух уровнях инициализации (Assembly и Class)

#### 3.4. Методы KafkaContainerExtensions
- Используется `GetBootstrapAddress()` (из Testcontainers) в `ConsumeMessages`, но в навыке упоминается только `GetBootstrapServers()`
- Существует метод `DeleteTopicsByPatternAsync()` для удаления топиков по паттерну
- **Решение**: Добавить информацию о всех доступных методах

#### 3.5. Дополнительные extension методы
- `WithSlaMailingsMockClient()`, `WithKafkaLimitCheckerMock()`, `WithFeatures()` и другие
- Определены в различных местах проекта
- **Решение**: Упомянуть, что могут существовать дополнительные extension методы для настройки моков

### 4. Противоречие в правилах использования IServiceProvider

**Проблема**: В навыке строго запрещено использование `IServiceProvider`, но в реальном коде есть исключения:

```csharp
// Пример из CustomerDataProcessorTests.cs:156
var repo = _worker.Services.GetRequiredService<IFrequencyPolicySentMessagesRepository>();
await Assertions.AssertFrequencyPolicyAttemptsRegisteredAsync(repo, ...);
```

**Анализ использования GetRequiredService в проекте**:
- `IFrequencyPolicySentMessagesRepository` - для проверки состояния БД (Cassandra)
- `ManualMailingProcessorFactory` - для прямого тестирования процессора (возможно, нарушение правила)
- `IAsyncConsumerHostFactory` - для тестирования хоста (возможно, нарушение правила)

**Решение**: Уточнить правило:
- ✅ **Разрешено**: Получение репозиториев для проверки состояния БД/хранилищ (Cassandra, Redis и т.д.)
- ✅ **Разрешено**: Получение сервисов только для чтения состояния (read-only проверки)
- ❌ **Запрещено**: Прямой вызов бизнес-логики через сервисы вместо публичного API
- ❌ **Запрещено**: Получение консюмеров/процессоров для прямого вызова

### 5. Структура Assertions

**Наблюдения**:
- Используется `HashSet` для проверки сообщений (как указано в навыке)
- Но также используется `Assert.IsTrue()` из MSTest вместо FluentAssertions в некоторых местах
- **Решение**: Уточнить, что можно использовать оба подхода, но FluentAssertions предпочтительнее

### 6. Дополнительные улучшения

#### 6.1. Информация о TestApp паттерне
- Статический класс `TestApp` с общими контейнерами на уровне Assembly
- Методы `RunServicesApp()`, `RunWorkControlApp()`, `RunMailingsPipelineApp()`, `RunManualMailingsApp()`
- **Решение**: Добавить раздел о паттерне TestApp

#### 6.2. Информация о WaitWhileTopicConsumedAsync
- Метод для ожидания обработки топика
- Используется через `_app.Services.WaitWhileTopicConsumedAsync()`
- **Решение**: Добавить пример использования

#### 6.3. Информация о настройке WireMock в AssemblyInitialize
- WireMock серверы могут настраиваться в `[AssemblyInitialize]`
- Пример: `MailingsMicroservice`, `TenantsMicroservice`, `WebPushGate` в `TestApp.cs`
- **Решение**: Добавить пример настройки нескольких WireMock серверов на уровне Assembly

#### 6.4. Информация о Flyway контейнере
- Используется связанный контейнер Flyway для миграций Cassandra
- Создается через `CassandraContainerExtensions.CreateFlywayContainer()`
- **Решение**: Уточнить пример с Cassandra + Flyway

## Рекомендуемые изменения

1. **Исправить пути и ссылки** на несуществующие файлы
2. **Добавить раздел о ролях приложения** и методах `As*Role()`
3. **Добавить информацию о двух уровнях инициализации** (Assembly и Class)
4. **Уточнить правило использования IServiceProvider** с примерами разрешенных и запрещенных случаев
5. **Добавить информацию о паттерне TestApp** с общими контейнерами
6. **Добавить информацию о всех методах KafkaContainerExtensions**
7. **Добавить примеры использования WaitWhileTopicConsumedAsync**
8. **Уточнить информацию о extension methods pattern** в C# 13
9. **Добавить информацию о настройке нескольких WireMock серверов**

## Приоритеты

**Высокий приоритет**:
- Исправление пути к ConfigBuilderExtensions
- Уточнение правила использования IServiceProvider
- Добавление информации о ролях приложения

**Средний приоритет**:
- Информация о двух уровнях инициализации
- Паттерн TestApp
- Все методы KafkaContainerExtensions

**Низкий приоритет**:
- Удаление ссылок на несуществующие файлы примеров (или их создание)
- Дополнительные примеры использования